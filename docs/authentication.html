<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - Service Assessment Service Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        header {
            background: #1d70b8;
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding-left: 2rem;
            padding-right: 2rem;
        }
        
        header h1 {
            margin-bottom: 0.25rem;
            font-size: 1.75rem;
        }
        
        header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 0;
        }
        
        .sidebar {
            width: 280px;
            background: #003078;
            color: white;
            padding: 2rem 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }
        
        .sidebar nav {
            padding: 0 1rem;
        }
        
        .sidebar nav ul {
            list-style: none;
        }
        
        .sidebar nav li {
            margin: 0.25rem 0;
        }
        
        .sidebar nav a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            padding: 0.75rem 1rem;
            display: block;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        
        .sidebar nav a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar nav a.active {
            background: #1d70b8;
            color: white;
            font-weight: 500;
        }
        
        .content-wrapper {
            flex: 1;
            background: #f5f5f5;
            padding: 2rem;
            min-height: calc(100vh - 80px);
        }
        
        .content {
            background: white;
            padding: 2.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 1000px;
        }
        
        
        h1, h2, h3, h4 {
            color: #1d70b8;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        
        h1 {
            font-size: 2.25rem;
            margin-top: 0;
            border-bottom: 3px solid #1d70b8;
            padding-bottom: 0.75rem;
        }
        
        h2 {
            font-size: 1.75rem;
            border-bottom: 2px solid #1d70b8;
            padding-bottom: 0.5rem;
            margin-top: 2.5rem;
        }
        
        h3 {
            font-size: 1.35rem;
            margin-top: 1.5rem;
            color: #1d70b8;
        }
        
        h4 {
            font-size: 1.15rem;
            color: #003078;
            margin-top: 1rem;
        }
        
        
        a {
            color: #1d70b8;
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.95rem;
        }
        
        table th, table td {
            padding: 0.875rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background: #1d70b8;
            color: white;
            font-weight: 600;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        code {
            background: #f4f4f4;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #d4351c;
        }
        
        pre {
            background: #f4f4f4;
            padding: 1.25rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 1.5rem 0;
            border-left: 4px solid #1d70b8;
        }
        
        ul, ol {
            margin-left: 2rem;
            margin-top: 0.75rem;
        }
        
        li {
            margin: 0.5rem 0;
            line-height: 1.7;
        }
        
        p {
            margin: 1rem 0;
            line-height: 1.7;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                position: relative;
                top: 0;
                height: auto;
            }
            
            .content-wrapper {
                padding: 1rem;
            }
            
            
        }
    </style>
</head>
<body>
        <header>
        <h1>Service Assessment Service</h1>
        <p>Authentication Documentation</p>
    </header>
    
    <div class="main-container">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="features.html">Features</a></li>
                    <li><a href="data-models.html">Data Models</a></li>
                    <li><a href="data-dictionary.html">Data Dictionary</a></li>
                    <li><a href="user-flows.html">User Flows</a></li>
                    <li><a href="models.html">Application Models</a></li>
                    <li><a href="authentication.html" class="active">Authentication</a></li>
                    <li><a href="roadmap.html">Roadmap</a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="content-wrapper">
                <div class="content"><h1>Authentication Documentation</h1>
            
            <p>This document describes the authentication system used in the Service Assessment Service, including magic link authentication, session management, role-based access control, and security features.</p>
            
            <h2>Table of Contents</h2>
                <ul>
                    <li><a href="#overview">Authentication Overview</a></li>
                    <li><a href="#magic-link">Magic Link Authentication</a></li>
                    <li><a href="#session-management">Session Management</a></li>
                    <li><a href="#role-based-access">Role-Based Access Control</a></li>
                    <li><a href="#middleware">Authentication Middleware</a></li>
                    <li><a href="#security">Security Features</a></li>
                    <li><a href="#api-authentication">API Authentication</a></li>
                </ul>
            
            <section id="overview" >
                <h2>Authentication Overview</h2>
                
                <p>The Service Assessment Service uses a passwordless authentication system based on magic links sent via email. This provides a secure, user-friendly authentication experience without requiring users to remember passwords.</p>
                
                <h3>Key Features</h3>
                <ul>
                    <li><strong>Passwordless Authentication:</strong> No passwords required - users sign in using magic links sent to their email</li>
                    <li><strong>Email Domain-Based Registration:</strong> User registration is controlled by email domain whitelist</li>
                    <li><strong>Time-Limited Tokens:</strong> Magic link tokens expire after 30 minutes</li>
                    <li><strong>Session-Based:</strong> Uses PostgreSQL-backed sessions for persistence</li>
                    <li><strong>Role-Based Access Control:</strong> Different access levels based on user roles</li>
                    <li><strong>Automatic User Creation:</strong> Users are automatically created on first sign-in (if domain allowed)</li>
                </ul>
            </section>
            
            <section id="magic-link" >
                <h2>Magic Link Authentication</h2>
                
                <h3>Sign-In Process</h3>
                
                <div >
                    <h4>Step 1: User Requests Sign-In</h4>
                    <p>User navigates to <code>/sign-in</code> and enters their email address</p>
                </div>
                
                <div >
                    <h4>Step 2: Email Validation</h4>
                    <p>System validates the email address:
                        <ul>
                            <li>Checks email format is valid</li>
                            <li>Extracts domain from email address</li>
                            <li>Checks if domain is in allowed domains list (<code>allowRegistrationFrom</code> environment variable)</li>
                        </ul>
                    </p>
                </div>
                
                <div >
                    <h4>Step 3: Token Generation</h4>
                    <p>If domain is allowed, system:
                        <ul>
                            <li>Generates a UUID v4 token</li>
                            <li>Sets token expiry to 30 minutes from now</li>
                            <li>Calls <code>checkAndSetUserToken()</code> which:
                                <ul>
                                    <li>Checks if user exists in database</li>
                                    <li>If user exists: Updates token and expiry</li>
                                    <li>If user doesn't exist: Creates new user (if domain allowed)</li>
                                    <li>Retrieves department ID based on email domain</li>
                                </ul>
                            </li>
                        </ul>
                    </p>
                </div>
                
                <div >
                    <h4>Step 4: Email Sent</h4>
                    <p>System sends magic link email via GOV.UK Notify:
                        <ul>
                            <li>Template ID: <code>email_MagicLinkTemplate</code> (environment variable)</li>
                            <li>Email contains link: <code>{serviceURL}/auth/t/{token}</code></li>
                            <li>Link expires in 30 minutes</li>
                        </ul>
                    </p>
                </div>
                
                <div >
                    <h4>Step 5: Token Validation</h4>
                    <p>User clicks magic link and system:
                        <ul>
                            <li>Extracts token from URL</li>
                            <li>Calls <code>checkToken()</code> which:
                                <ul>
                                    <li>Queries database for token</li>
                                    <li>Checks token has not expired (<code>TokenExpiry > NOW()</code>)</li>
                                    <li>Returns user details if valid (UserID, EmailAddress, FirstName, LastName, Department)</li>
                                </ul>
                            </li>
                        </ul>
                    </p>
                </div>
                
                <div >
                    <h4>Step 6: Session Creation</h4>
                    <p>If token is valid, system:
                        <ul>
                            <li>Creates user session</li>
                            <li>Stores <code>UserId</code> in session</li>
                            <li>Stores user object in <code>session.data.User</code></li>
                            <li>Fetches user roles to determine admin status</li>
                            <li>Fetches assessor status</li>
                            <li>Fetches department information</li>
                        </ul>
                    </p>
                </div>
                
                <div >
                    <h4>Step 7: Profile Check</h4>
                    <p>System checks if user has completed profile:
                        <ul>
                            <li>If FirstName or LastName is empty: Redirects to <code>/profile/change-name</code></li>
                            <li>If profile complete: Checks for <code>originalUrl</code> in session (if user was redirected to sign-in)</li>
                            <li>Redirects to original URL or default to <code>/manage</code></li>
                        </ul>
                    </p>
                </div>
                
                <h3>Code Implementation</h3>
                <p>Magic link authentication is implemented in:</p>
                <ul>
                    <li><strong>Controller:</strong> <code>app/controllers/authController.js</code></li>
                    <li><strong>Model:</strong> <code>app/models/user.js</code></li>
                    <li><strong>Validation:</strong> <code>app/validation/authValidation.js</code></li>
                </ul>
            </section>
            
            <section id="session-management" >
                <h2>Session Management</h2>
                
                <h3>Session Storage</h3>
                <p>Sessions are stored in PostgreSQL using <code>connect-pg-simple</code> package:</p>
                
                <ul>
                    <li><strong>Table:</strong> <code>sessions</code></li>
                    <li><strong>Session ID:</strong> Stored in <code>sid</code> column (primary key)</li>
                    <li><strong>Session Data:</strong> Stored as JSON in <code>sess</code> column</li>
                    <li><strong>Expiry:</strong> Stored in <code>expire</code> column (indexed for automatic cleanup)</li>
                </ul>
                
                <h3>Session Configuration</h3>
                <pre><code>app.use(session({
    store: new pgSession({
        pool: pgPool,
        tableName: 'sessions'
    }),
    secret: process.env.sessionkey,
    resave: false,
    rolling: true,
    saveUninitialized: false,
    cookie: { maxAge: 365 * 24 * 60 * 60 * 1000 } // 1 year
}));</code></pre>
                
                <h3>Session Data Structure</h3>
                <p>The session stores the following data:</p>
                <ul>
                    <li><code>UserId</code> - User ID from database</li>
                    <li><code>data.User</code> - User object (UserID, EmailAddress, FirstName, LastName, Department)</li>
                    <li><code>data.IsAdmin</code> - Boolean indicating if user has admin role</li>
                    <li><code>data.IsAssessor</code> - Boolean indicating if user is an assessor</li>
                    <li><code>data.Department</code> - Department object with name</li>
                    <li><code>originalUrl</code> - URL user was trying to access before authentication (if redirected)</li>
                    <li><code>data</code> - General form data storage (via middleware)</li>
                </ul>
                
                <h3>Session Middleware</h3>
                <p>The application uses custom middleware for session data management:</p>
                <ul>
                    <li><code>saveFormDataToSession</code> - Saves POST form data to session</li>
                    <li><code>makeFormDataGlobal</code> - Makes session data available to all views</li>
                </ul>
                
                <h3>Sign-Out</h3>
                <p>Users sign out via <code>/sign-out</code> route which:
                    <ul>
                        <li>Destroys the session</li>
                        <li>Clears session cookie</li>
                        <li>Redirects to sign-in page</li>
                    </ul>
                </p>
            </section>
            
            <section id="role-based-access" >
                <h2>Role-Based Access Control</h2>
                
                <h3>User Roles</h3>
                <p>The system supports the following roles (stored in <code>UserRole</code> table):</p>
                
                <table>
                    <thead>
                        <tr>
                            <th>Role</th>
                            <th>Description</th>
                            <th>Access Level</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Standard User</strong></td>
                            <td>Default role for all authenticated users</td>
                            <td>
                                <ul>
                                    <li>Book assessments</li>
                                    <li>Manage their own assessments</li>
                                    <li>View published reports</li>
                                    <li>Manage profile</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Assessor</strong></td>
                            <td>Users who can assess services (stored in <code>Assessor</code> table)</td>
                            <td>
                                <ul>
                                    <li>All standard user access</li>
                                    <li>Assess services against Service Standard</li>
                                    <li>Volunteer for assessments</li>
                                    <li>View assessment history</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Administrator</strong></td>
                            <td>Department-level administrator (stored in <code>UserRole</code> table)</td>
                            <td>
                                <ul>
                                    <li>All assessor access</li>
                                    <li>Manage assessments across department</li>
                                    <li>Assign assessment panels</li>
                                    <li>Manage assessors</li>
                                    <li>View reports and analytics</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Department lead</strong></td>
                            <td>Department head administrator (stored in <code>UserRole</code> table)</td>
                            <td>
                                <ul>
                                    <li>All administrator access</li>
                                    <li>Manage department administrators</li>
                                    <li>Enhanced department management</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Service Administrator</strong></td>
                            <td>Cross-department administrator (stored in <code>UserRole</code> table)</td>
                            <td>
                                <ul>
                                    <li>All administrator access</li>
                                    <li>Access across multiple departments</li>
                                    <li>System-wide administration</li>
                                </ul>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>Role Checking</h3>
                <p>Roles are checked at multiple levels:</p>
                <ul>
                    <li><strong>Session:</strong> User roles are loaded into session on authentication</li>
                    <li><strong>Middleware:</strong> Route middleware checks roles before allowing access</li>
                    <li><strong>Database:</strong> Roles are stored in <code>UserRole</code> table</li>
                    <li><strong>Assessor Status:</strong> Stored separately in <code>Assessor</code> table</li>
                </ul>
            </section>
            
            <section id="middleware" >
                <h2>Authentication Middleware</h2>
                
                <h3>isAuthenticated</h3>
                <p>Basic authentication middleware that checks if user is signed in:</p>
                <pre><code>function isAuthenticated(req, res, next) {
    if (req.session && req.session.UserId && req.session.data.User) {
        return next();
    } else {
        req.session.originalUrl = req.originalUrl;
        return res.redirect('/sign-in');
    }
}</code></pre>
                <p><strong>Usage:</strong> Applied to all protected routes</p>
                
                <h3>isAdmin</h3>
                <p>Checks if user has admin role (Administrator, Department lead, or Service Administrator):</p>
                <pre><code>async function isAdmin(req, res, next) {
    if (req.session && req.session.UserId && req.session.data.User) {
        const userID = parseInt(req.session.data.User.UserID);
        const userRoles = await getRolesByUserID(userID);
        const userRolesList = userRoles.map(role => role.UserRole);
        
        if (userRolesList.some(role => rolesToCheck.includes(role))) {
            return next();
        } else {
            return res.redirect('/profile');
        }
    } else {
        return res.redirect('/sign-out');
    }
}</code></pre>
                <p><strong>Usage:</strong> Applied to admin routes</p>
                
                <h3>isAssessor</h3>
                <p>Checks if user is an assessor (or admin):</p>
                <pre><code>async function isAssessor(req, res, next) {
    if (req.session && req.session.UserId && req.session.data.User) {
        const userID = parseInt(req.session.data.User.UserID);
        const assessor = await getAssessorByUserID(userID);
        
        if (assessor) {
            return next();
        } else {
            const userRoles = await getRolesByUserID(userID);
            const userRolesList = userRoles.map(role => role.UserRole);
            
            if (userRolesList.some(role => rolesToCheck.includes(role))) {
                return next(); // Admins can also access assessor routes
            } else {
                return res.redirect('/not-assessor');
            }
        }
    } else {
        return res.redirect('/sign-out');
    }
}</code></pre>
                <p><strong>Usage:</strong> Applied to assessor routes</p>
                
                <h3>canAccessAsAssessor</h3>
                <p>Checks if user can access specific assessment as assessor (is on panel or is admin):</p>
                <pre><code>async function canAccessAsAssessor(req, res, next) {
    if (req.session && req.session.UserId && req.session.data.User) {
        const userID = parseInt(req.session.data.User.UserID);
        
        // Check if user is admin
        const userRoles = await getRolesByUserID(userID);
        const userRolesList = userRoles.map(role => role.UserRole);
        
        if (userRolesList.some(role => rolesToCheck.includes(role))) {
            return next(); // Admins can access any assessment
        }
        
        const assessmentID = parseInt(req.params.assessmentID, 10);
        const panel = await assessmentPanel(assessmentID);
        
        if (panel && panel.some(member => member.UserID === userID)) {
            return next(); // User is on panel
        } else {
            return res.redirect('/assess');
        }
    } else {
        return res.redirect('/sign-out');
    }
}</code></pre>
                <p><strong>Usage:</strong> Applied to assessment-specific assessor routes</p>
                
                <h3>canAccess</h3>
                <p>Checks if user can access specific assessment (is creator, DD, PM, DM, or team member):</p>
                <pre><code>async function canAccess(req, res, next) {
    if (!req.session || !req.session.UserId || !req.session.data.User) {
        return res.redirect('/login');
    }
    
    const userID = parseInt(req.session.data.User.UserID);
    const assessmentID = req.params.assessmentID;
    
    const assessment = await getAssessmentById(assessmentID);
    const team = await getTeamForAssessmentExtended(assessmentID);
    
    if (assessment.CreatedBy == userID || 
        assessment.DD == userID || 
        assessment.PM == userID || 
        assessment.DM == userID || 
        team.some(member => member.UserID == userID)) {
        return next();
    } else {
        return res.redirect('/manage');
    }
}</code></pre>
                <p><strong>Usage:</strong> Applied to assessment-specific management routes</p>
            </section>
            
            <section id="security" >
                <h2>Security Features</h2>
                
                <div class="security-note">
                    <strong>Security Best Practices</strong>
                    <p>The authentication system implements several security measures:</p>
                </div>
                
                <h3>Token Security</h3>
                <ul>
                    <li><strong>UUID v4 Tokens:</strong> Uses cryptographically secure UUID v4 for tokens</li>
                    <li><strong>Time-Limited:</strong> Tokens expire after 30 minutes</li>
                    <li><strong>Single-Use:</strong> Tokens are validated once and session is created</li>
                    <li><strong>Database Storage:</strong> Tokens stored securely in database</li>
                </ul>
                
                <h3>Email Domain Whitelisting</h3>
                <ul>
                    <li><strong>Domain Validation:</strong> Only email addresses from whitelisted domains can register</li>
                    <li><strong>Environment Variable:</strong> Allowed domains configured via <code>allowRegistrationFrom</code></li>
                    <li><strong>Department Assignment:</strong> Users automatically assigned to department based on email domain</li>
                </ul>
                
                <h3>Session Security</h3>
                <ul>
                    <li><strong>HTTP-Only Cookies:</strong> Session cookies are HTTP-only (prevents JavaScript access)</li>
                    <li><strong>Secure Storage:</strong> Sessions stored in PostgreSQL (not client-side)</li>
                    <li><strong>Automatic Expiry:</strong> Sessions expire after 1 year of inactivity</li>
                    <li><strong>Rolling Sessions:</strong> Session expiry extended on each request</li>
                </ul>
                
                <h3>Input Validation</h3>
                <ul>
                    <li><strong>Email Validation:</strong> Email addresses validated using express-validator</li>
                    <li><strong>Parameter Validation:</strong> Route parameters validated as integers</li>
                    <li><strong>SQL Injection Prevention:</strong> Uses parameterized queries</li>
                </ul>
                
                <h3>Access Control</h3>
                <ul>
                    <li><strong>Route Protection:</strong> Middleware protects routes based on authentication status</li>
                    <li><strong>Role-Based Access:</strong> Different access levels based on user roles</li>
                    <li><strong>Assessment Access Control:</strong> Users can only access assessments they're associated with</li>
                    <li><strong>Department Isolation:</strong> Users can only access assessments from their department (unless admin)</li>
                </ul>
            </section>
            
            <section id="api-authentication" >
                <h2>API Authentication</h2>
                
                <h3>API Token Authentication</h3>
                <p>The API endpoints use token-based authentication via the <code>authenticateApiToken</code> middleware in <code>app/controllers/apiController.js</code>.</p>
                
                <h3>Authenticated API Endpoints</h3>
                <ul>
                    <li><code>GET /api/product/:fips_id</code> - Get product by FIPS ID</li>
                    <li><code>GET /api/assessments/published/summary</code> - Get published assessments summary</li>
                    <li><code>GET /api/assessments/published/actions-by-standard</code> - Get actions by standard</li>
                    <li><code>GET /api/assessments/published/by-portfolio-dd</code> - Get assessments by portfolio and DD</li>
                    <li><code>GET /api/assessments/:assessmentID/actions</code> - Get actions for assessment</li>
                    <li><code>GET /api/assessments/actions/all</code> - Get all actions grouped by assessment</li>
                    <li><code>PUT /api/assessments/:assessmentID/fips-id</code> - Update assessment FIPS ID</li>
                </ul>
                
                <h3>Implementation</h3>
                <p>API authentication is implemented via middleware that validates API tokens. The token is typically passed in the request headers or as a query parameter.</p>
            </section>
                        </div>
        
    </div>
        </main>
    </div>
</body>
</html>

