{% extends "layouts/auth.html" %}

{% set selectedNav = "Reports" %}
{% set pageName = "Assessment and peer review reports" %}
{% set view = "reports" %}

{% block hero %}
<div class="dfe-page-header dfe-page-header--with-sub-nav">
    <div class="govuk-width-container dfe-width-container ">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <span class="govuk-caption-l">Reports</span>
                <h1 class="govuk-heading-l">{{pageName}}</h1>
                <nav class="app-sub-navigation" aria-label="Application menu">
                    <ul class="app-sub-navigation__list">
                        <li class="app-sub-navigation__item">
                            <a class="app-sub-navigation__link" {% if view==="reports" %} aria-current="page" {% endif
                                %} href="/reports">Reports</a>
                        </li>
                        <li class="app-sub-navigation__item">
                            <a class="app-sub-navigation__link" {% if view==="analysis" %} aria-current="page" {% endif
                                %} href="/analysis">Analysis</a>
                        </li>



                        {# {% for i in range(1, 2) %}

                        <li class="app-sub-navigation__item">
                            <a class="app-sub-navigation__link" {% if year==(currentYear -i) %} aria-current="page" {%
                                endif %}href="/analysis/{{ currentYear -i}}">{{ currentYear -i}}</a>
                        </li>
                        {% endfor %} #}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}

<div class="govuk-grid-row">

    <div class="govuk-grid-column-one-quarter">
        <div class="govuk-summary-card">
            <div class="govuk-summary-card__title-wrapper">
                <h2 class="govuk-summary-card__title">Filters</h2>
                <ul class="govuk-summary-card__actions">
                    <li class="govuk-summary-card__action">
                        <a class="govuk-link" href="/reports">Clear</a>
                    </li>
                </ul>
            </div>
            <div class="govuk-summary-card__content">
                <div class="govuk-form-group">
                    <label id="filterTableLabel" for="filterTable" class="govuk-label govuk-!-font-weight-bold">Filter by name</label>
                    <input type="text" id="filterTable" class="govuk-input" aria-describedby="filterTableLabel" onkeyup="applyFilters()" />
                </div>
                <div class="govuk-form-group">
                    <fieldset class="govuk-fieldset">
                        <legend class="govuk-fieldset__legend  govuk-fieldset__legend--s">
                            Phase
                        </legend>
                        <div class="govuk-checkboxes govuk-checkboxes--small" data-module="govuk-checkboxes">
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="filter_phase" name="filter_phase"
                                    type="checkbox" value="Discovery">
                                <label class="govuk-label govuk-checkboxes__label" for="filter_phase">
                                    Discovery
                                </label>
                            </div>
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="filter_phase-2" name="filter_phase"
                                    type="checkbox" value="Alpha">
                                <label class="govuk-label govuk-checkboxes__label" for="filter_phase-2">
                                    Alpha
                                </label>
                            </div>
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="filter_phase-3" name="filter_phase"
                                    type="checkbox" value="Private Beta">
                                <label class="govuk-label govuk-checkboxes__label" for="filter_phase-3">
                                    Private Beta
                                </label>
                            </div>
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="filter_phase-4" name="filter_phase"
                                    type="checkbox" value="Public Beta">
                                <label class="govuk-label govuk-checkboxes__label" for="filter_phase-4">
                                    Public Beta
                                </label>
                            </div>
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="filter_phase-5" name="filter_phase"
                                    type="checkbox" value="Live">
                                <label class="govuk-label govuk-checkboxes__label" for="filter_phase-5">
                                    Live
                                </label>
                            </div>
                    </fieldset>
                </div>

                <div class="govuk-form-group">
                    <fieldset class="govuk-fieldset">
                        <legend class="govuk-fieldset__legend  govuk-fieldset__legend--s">
                            Outcomes
                        </legend>
                        <div class="govuk-checkboxes govuk-checkboxes--small" data-module="govuk-checkboxes">
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="filter_outcome" name="filter_outcome"
                                    type="checkbox" value="Red">
                                <label class="govuk-label govuk-checkboxes__label" for="filter_outcome">
                                    Red
                                </label>
                            </div>
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="filter_outcome-2" name="filter_outcome"
                                    type="checkbox" value="Amber">
                                <label class="govuk-label govuk-checkboxes__label" for="filter_outcome-2">
                                    Amber
                                </label>
                            </div>
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="filter_outcome-3" name="filter_outcome"
                                    type="checkbox" value="Green">
                                <label class="govuk-label govuk-checkboxes__label" for="filter_outcome-3">
                                    Green
                                </label>
                            </div>
                    </fieldset>
                </div>

                <div class="govuk-form-group">
                    <fieldset class="govuk-fieldset">
                        <legend class="govuk-fieldset__legend  govuk-fieldset__legend--s">
                            Type
                        </legend>
                        <div class="govuk-checkboxes govuk-checkboxes--small" data-module="govuk-checkboxes">
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="filter_type" name="filter_type"
                                    type="checkbox" value="Service assessment">
                                <label class="govuk-label govuk-checkboxes__label" for="filter_type">
                                    Assessment
                                </label>
                            </div>
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="filter_type-2" name="filter_type"
                                    type="checkbox" value="Peer review">
                                <label class="govuk-label govuk-checkboxes__label" for="filter_type-2">
                                    Peer review
                                </label>
                            </div>

                    </fieldset>
                </div>
            </div>
        </div>
    </div>
    <div class="govuk-grid-column-three-quarters">
        <div id="count-of-items" class="govuk-heading-m govuk-!-padding-top-4 govuk-!-margin-bottom-3" aria-live="polite">{{ assessments | length }}</div>
        <hr class="govuk-section-break govuk-section-break--visible">
        <ul class="dfe-items-list govuk-!-margin-top-2">
            {% for assessment in assessments %}
            <li class="row dfe-items-list--{{ assessment.Outcome | lower }}" data-phase="{{ assessment.Phase }}" data-type="{{ assessment.Type }}" data-outcome="{{ assessment.Outcome }}" data-name="{{ assessment.Name | lower }}">
                <div>
                    <h2 class="govuk-heading-s govuk-!-margin-bottom-2">
                        <a class="govuk-link govuk-link--no-visited-state" href="/reports/report/{{ assessment.AssessmentID }}">{{ assessment.Name }}</a>
                    </h2>
                </div>
                <div class="govuk-grid-row">
                    <div class="govuk-grid-column-one-half">
                        <ul class="govuk-list govuk-!-font-size-16">
                            <li><span class="govuk-!-font-weight-bold">Outcome:</span>
                                <strong class="govuk-tag govuk-!-font-size-16 govuk-tag--{{ assessment.Outcome | lower }}">{{ assessment.Outcome }}</strong>
                            </li>
                            <li><span class="govuk-!-font-weight-bold">Type:</span> {{ assessment.Type }}</li>
                        </ul>
                    </div>
                    <div class="govuk-grid-column-one-half">
                        <ul class="govuk-list govuk-!-font-size-16">
                            <li><span class="govuk-!-font-weight-bold">Phase:</span> {{ assessment.Phase }}</li>
                            <li><span class="govuk-!-font-weight-bold">Date:</span> {{ assessment.AssessmentDateTime | date('D MMMM YYYY') }}</li>
                        </ul>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
        <div id="noResultsMessage" style="display: none;">
            <p class="govuk-heading-m">No results for the filter.</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const filterInput = document.getElementById('filterTable');
        filterInput.addEventListener('keyup', applyFilters); // Ensure this is binding correctly
    
        const filters = document.querySelectorAll('.govuk-checkboxes__input');
        filters.forEach(filter => filter.addEventListener('change', applyFilters));
    
        function applyFilters() {
            console.log('Filtering items...'); // Debug statement
            let nameFilter = filterInput.value.toLowerCase();
            let activePhases = getActiveFilters('filter_phase');
            let activeOutcomes = getActiveFilters('filter_outcome');
            let activeTypes = getActiveFilters('filter_type');
            let rows = document.querySelectorAll('.dfe-items-list > li');
    
            let visibleCount = 0;
            rows.forEach(row => {
                let name = row.getAttribute('data-name');
                let phase = row.getAttribute('data-phase');
                let outcome = row.getAttribute('data-outcome');
                let type = row.getAttribute('data-type');
                let isVisible = (name.includes(nameFilter) || nameFilter === '') &&
                                (activePhases.includes(phase) || activePhases.length === 0) &&
                                (activeOutcomes.includes(outcome) || activeOutcomes.length === 0) &&
                                (activeTypes.includes(type) || activeTypes.length === 0);
    
                row.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });
    
            document.getElementById('noResultsMessage').style.display = visibleCount > 0 ? 'none' : '';
            updateItemCount(visibleCount);
        }
    
        function getActiveFilters(filterName) {
            return Array.from(document.querySelectorAll(`input[name="${filterName}"]:checked`)).map(el => el.value);
        }
    
        function updateItemCount(count) {
            const countElement = document.getElementById('count-of-items');
            countElement.textContent = count + ' reports';
        }
    
        applyFilters(); // Apply filters on initial load to sync with current filter state
    });
    </script>
    

{% endblock %}